<!DOCTYPE html>
<html lang="{{- site.Language.LanguageCode -}}" dir="{{- or site.Language.LanguageDirection `ltr` -}}" data-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>{{- if .IsHome -}}{{- site.Title -}}{{- else -}}{{- printf "%s" .Title -}}{{- end -}}</title>
    {{- if .Description -}}<meta name="description" content="{{- if .IsHome -}}{{- site.Params.description -}}{{- else -}}{{- .Description -}}{{- end -}}">{{- end -}}
    {{- if len .Keywords -}}<meta name="keywords" content="{{- delimit .Keywords "," -}}">{{- end -}}
    {{- partialCached "head/css.html" . -}}
    {{- partialCached "head/js.html" . -}}
    {{- if hugo.IsProduction -}}
      {{- if site.Config.Services.GoogleAnalytics.ID -}}
        {{- partial "google-analytics.html" -}}
      {{- end -}}
      {{- if site.Params.GoogleAdSense.ID -}}
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{- site.Params.GoogleAdSense.ID -}}" crossorigin="anonymous"></script>
      {{- end -}}
    {{- end -}}
    {{- if .Param "math" -}}
      {{- partialCached "math.html" . -}}
    {{- end -}}

    <script defer>
      // 检测系统主题
      function setThemeBasedOnSystemPreference() {
        const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const lightModeMediaQuery = window.matchMedia('(prefers-color-scheme: light)');

        function applyTheme() {
          let storedTheme = localStorage.getItem('theme');
          if (storedTheme) {
            document.documentElement.setAttribute('data-theme', storedTheme);
          } else {
            if (darkModeMediaQuery.matches) {
              document.documentElement.setAttribute('data-theme', 'dark');
            } else  { // light as default
              document.documentElement.setAttribute('data-theme', 'light');
            }
          }
          updateIcons();
        }

        // 初始应用主题
        applyTheme();

        // 监听系统主题变化
        darkModeMediaQuery.addEventListener('change', applyTheme);
        lightModeMediaQuery.addEventListener('change', applyTheme);
      }

      function changeTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateIcons();
      }

      function updateIcons() {
        const sunIcon = document.getElementById('sun-icon');
        const sunIconMobile = document.getElementById('sun-icon-mobile');
        const moonIcon = document.getElementById('moon-icon');
        const moonIconMobile = document.getElementById('moon-icon-mobile');

        const currentTheme = document.documentElement.getAttribute('data-theme');

        if (currentTheme === 'dark') {
          sunIcon.classList.remove('hidden');
          sunIconMobile.classList.remove('hidden');
          moonIcon.classList.add('hidden');
          moonIconMobile.classList.add('hidden');
        } else {
          sunIcon.classList.add('hidden');
          sunIconMobile.classList.add('hidden');
          moonIcon.classList.remove('hidden');
          moonIconMobile.classList.remove('hidden');
        }
      }
      // 在DOM加载完成后执行
      document.addEventListener('DOMContentLoaded', setThemeBasedOnSystemPreference);
    </script>
  </head>
  <body class="flex flex-col items-center min-h-screen">
    <header class="navbar bg-base-200">
      <div class="flex-1">
        <a class="btn btn-ghost text-xl" href="/">{{- site.Title -}}</a>
      </div>

      <div class="hidden md:flex flex-row items-center">
        <button id="theme-toggle" onclick="changeTheme()" class="btn btn-ghost">
          {{- /* sun icon */ -}}
          <div id="sun-icon" class="fill-current">
          {{- partialCached "icons/sun.html" . -}}
          </div>
          {{- /* moon icon */ -}}
          <div id="moon-icon" class="hidden fill-current">
          {{- partialCached "icons/moon.html" . -}}
          </div>
        </button>
        <ul class="menu menu-horizontal px-1">
          {{- range site.Menus.main -}}
            <li><a href="{{- .URL -}}">{{- .Name -}}</a></li>
          {{- end -}}
        </ul>
      </div>

      <div class="flex-none md:hidden">
        <button id="theme-toggle" onclick="changeTheme()">
          {{- /* sun icon */ -}}
          <div id="sun-icon-mobile" class="fill-primary">
            {{- partialCached "icons/sun.html" . -}}
          </div>

          {{- /* moon icon */ -}}
          <div id="moon-icon-mobile" class="fill-primary">
            {{- partialCached "icons/moon.html" . -}}
          </div>
        </button>
        <ul class="menu menu-horizontal px-1">
          <li>
            <details>
              <summary>
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" class="fill-primary">
                  <path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>
                </svg>
              </summary>
              <ul class="bg-base-100 rounded-t-none p-1">
                {{- range site.Menus.main -}}
                  <li><a href="{{- .URL -}}">{{- .Name -}}</a></li>
                {{- end -}}
              </ul>
            </details>
          </li>
        </ul>
      </div>
    </header>

    <main id="content-zone" class="px-4 w-full md:max-w-5xl prose flex flex-col md:flex-row md:space-x-8 justify-center">
      <article class="flex-1 max-w-none">
        {{- block "main" . -}}{{- end -}}
      </article>
      <div class="divider pt-16 pb-0 lg:hidden"></div>
      <aside class="w-full lg:w-1/3 flex flex-col">
        {{- partial "sidebar/related-post.html" . -}}
        {{- partialCached "sidebar/latest-post.html" . -}}
        {{- partialCached "sidebar/most-visited-sidebar.html" . -}}
        {{- partialCached "sidebar/category.html" . -}}
        {{- partialCached "sidebar/tags.html" . -}}
      </aside>
    </main>

    <footer class="prose flex-none mt-12">
      <p class="prose-xs text-neutral-content mt-4 mb-4">
        <span>Copyright</span>
        <span>{{- now.Year -}}</span>
        <span>{{- site.Title -}}</span>
      </p>
    </footer>
  </body>
</html>
